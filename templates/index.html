<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meal Bot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; display: flex; align-items: center; justify-content: center; height: 100vh; }
        .card { width: 100%; max-width: 600px; min-height: 400px; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: center; }
        .btn-action { padding: 15px 0; font-size: 1.5rem; width: 45%; border-radius: 12px; }
        .hidden { display: none !important; }
        #ingredient-display { font-size: 2.0rem; font-weight: bold; margin: 20px 0; text-transform: capitalize; }
        #recipe-context { font-size: 0.9rem; color: #6c757d; text-align: left; margin-top: 10px; max-height: 150px; overflow-y: auto; background: #f1f3f5; padding: 10px; border-radius: 8px;}
        .config-row { text-align: left; margin-bottom: 15px; }
    </style>
</head>
<body>

    <div class="container text-center">
        
        <!-- Config/Start View -->
        <div id="start-view" class="card mx-auto">
            <h2>Setup Planner</h2>
            
            <div class="config-row mt-4">
                <label class="form-label fw-bold">Scan List (Recipes)</label>
                <input type="text" id="input-list" class="form-control" value="Meals" placeholder="e.g. Meals">
            </div>

            <div class="config-row">
                <label class="form-label fw-bold">Target List (Groceries)</label>
                <input type="text" id="output-list" class="form-control" value="Inbox" placeholder="e.g. Shopping">
            </div>

            <div class="config-row">
                <label class="form-label fw-bold">Parent Task Name (Optional)</label>
                <input type="text" id="parent-task" class="form-control" value="Grocery Run" placeholder="Leave empty for individual tasks">
                <div class="form-text">If set, items become subtasks of this task.</div>
            </div>

            <button onclick="startScan()" class="btn btn-primary btn-lg mt-3">Start Scanning</button>
        </div>

        <!-- Loading View -->
        <div id="loading-view" class="card mx-auto hidden">
            <div class="spinner-border text-primary mx-auto" role="status" style="width: 3rem; height: 3rem;"></div>
            <h4 class="mt-3" id="loading-text">Reading recipes...</h4>
        </div>

        <!-- Chat Interface -->
        <div id="chat-view" class="card mx-auto hidden">
            <div class="text-muted text-uppercase small fw-bold">Do you need...</div>
            
            <div id="ingredient-display">Onions</div>
            
            <div id="recipe-context">
                <!-- Details injected here -->
            </div>
            
            <div class="d-flex justify-content-between mt-4">
                <button onclick="handleNo()" class="btn btn-outline-danger btn-action">No ‚ùå</button>
                <button onclick="handleYes()" class="btn btn-success btn-action">Yes ‚úÖ</button>
            </div>
            <div class="mt-3 text-muted">
                <small id="progress-indicator">Item 1 of 10</small>
            </div>
        </div>

        <!-- Success View -->
        <div id="success-view" class="card mx-auto hidden">
            <h2 class="text-success">Done! üéâ</h2>
            <p>I've added <span id="count-added">0</span> items to your list.</p>
            <button onclick="location.reload()" class="btn btn-primary">Start Over</button>
        </div>

    </div>

    <script>
        let ingredientsQueue = [];
        let selectedItems = [];
        let currentIndex = 0;

        // Config State
        let config = {
            inputList: "",
            outputList: "",
            parentTask: ""
        };

        async function startScan() {
            config.inputList = document.getElementById('input-list').value;
            config.outputList = document.getElementById('output-list').value;
            config.parentTask = document.getElementById('parent-task').value;

            document.getElementById('start-view').classList.add('hidden');
            document.getElementById('loading-view').classList.remove('hidden');
            document.getElementById('loading-text').innerText = "Scanning " + config.inputList + "...";

            try {
                const response = await fetch('/api/scan_meals', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ input_list_name: config.inputList })
                });
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    location.reload();
                    return;
                }

                ingredientsQueue = data.ingredients; // Now these are groups {name, details:[]}
                if (ingredientsQueue.length === 0) {
                    alert("No recipes found in '" + config.inputList + "'!");
                    location.reload();
                    return;
                }

                startChat();
            } catch (err) {
                alert("Error scanning meals.");
                console.error(err);
                location.reload();
            }
        }

        function startChat() {
            document.getElementById('loading-view').classList.add('hidden');
            document.getElementById('chat-view').classList.remove('hidden');
            currentIndex = 0;
            showCurrentItem();
        }

        function showCurrentItem() {
            if (currentIndex >= ingredientsQueue.length) {
                finishPlanning();
                return;
            }

            const group = ingredientsQueue[currentIndex];
            
            document.getElementById('ingredient-display').innerText = group.name;
            
            // Show details (amounts and source recipes)
            const detailsHtml = group.details.map(d => `<div>‚Ä¢ ${d}</div>`).join('');
            document.getElementById('recipe-context').innerHTML = detailsHtml;

            document.getElementById('progress-indicator').innerText = `Item ${currentIndex + 1} of ${ingredientsQueue.length}`;
        }

        function handleYes() {
            // Add the name of the ingredient group
            selectedItems.push(ingredientsQueue[currentIndex].name);
            currentIndex++;
            showCurrentItem();
        }

        function handleNo() {
            currentIndex++;
            showCurrentItem();
        }

        async function finishPlanning() {
            document.getElementById('chat-view').classList.add('hidden');
            document.getElementById('loading-view').classList.remove('hidden');
            document.getElementById('loading-text').innerText = "Syncing to TickTick...";

            try {
                const response = await fetch('/api/create_grocery_list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        items: selectedItems,
                        output_list_name: config.outputList,
                        parent_task_name: config.parentTask
                    })
                });
                
                document.getElementById('loading-view').classList.add('hidden');
                document.getElementById('success-view').classList.remove('hidden');
                document.getElementById('count-added').innerText = selectedItems.length;
            } catch (err) {
                alert("Error creating list.");
            }
        }
    </script>
</body>
</html>