<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meal Bot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; display: flex; align-items: center; justify-content: center; height: 100vh; }
        .card { width: 100%; max-width: 600px; min-height: 400px; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: center; }
        .btn-action { padding: 15px 0; font-size: 1.5rem; width: 45%; border-radius: 12px; }
        .hidden { display: none !important; }
        #ingredient-display { font-size: 2.0rem; font-weight: bold; text-transform: capitalize; }
        #recipe-context { font-size: 0.9rem; color: #6c757d; text-align: left; margin-top: 10px; max-height: 150px; overflow-y: auto; background: #f1f3f5; padding: 10px; border-radius: 8px;}
        .config-row { text-align: left; margin-bottom: 15px; }
    </style>
</head>
<body>

    <div class="container text-center">
        
        <!-- Config/Start View -->
        <div id="start-view" class="card mx-auto">
            <h2>Setup Planner</h2>
            
            <div class="config-row mt-4">
                <label class="form-label fw-bold">Scan List (Recipes)</label>
                <input type="text" id="input-list" class="form-control" value="Week's Meal Ideas" readonly disabled>
                <div class="form-text">Scanning list: Week's Meal Ideas, Section: Weekly Plan</div>
            </div>

            <div class="config-row">
                <label class="form-label fw-bold">Target List (Groceries)</label>
                <input type="text" id="output-list" class="form-control" value="Groceries" readonly disabled>
            </div>

            {% if logged_in %}
            <button onclick="startScan()" class="btn btn-primary btn-lg mt-3">Start Scanning</button>
            {% else %}
            <a href="/login" class="btn btn-primary btn-lg mt-3">Login to TickTick</a>
            {% endif %}
            <button onclick="showTestMode()" class="btn btn-secondary mt-3">Test Mode</button>
        </div>

        <!-- Test Input View -->
        <div id="test-input-view" class="card mx-auto hidden">
            <h2>Test Mode</h2>
            <p>Enter recipes or URLs (one per line):</p>
            <textarea id="test-input-text" class="form-control mb-3" rows="10" placeholder="https://example.com/recipe&#10;Chicken Parmesan"></textarea>
            <button onclick="startTestScan()" class="btn btn-primary btn-lg">Run Test</button>
            <button onclick="location.reload()" class="btn btn-outline-secondary mt-2">Cancel</button>
        </div>

        <!-- Loading View -->
        <div id="loading-view" class="card mx-auto hidden">
            <div class="spinner-border text-primary mx-auto" role="status" style="width: 3rem; height: 3rem;"></div>
            <h4 class="mt-3" id="loading-text">Reading recipes...</h4>
        </div>

        <!-- Chat Interface -->
        <div id="chat-view" class="card mx-auto hidden">
            <div class="text-muted text-uppercase small fw-bold">Do you need...</div>
            
            <div class="d-flex justify-content-center align-items-center my-3">
                <span id="ingredient-display">Onions</span>
                <input type="text" id="ingredient-edit-input" class="form-control hidden text-center fw-bold" style="font-size: 1.5rem; max-width: 300px;">

                <div class="ms-2">
                     <button id="edit-btn" onclick="enableEdit()" class="btn btn-outline-secondary btn-sm" title="Edit">‚úèÔ∏è</button>
                     <div id="edit-actions" class="hidden d-flex gap-1">
                        <button onclick="saveEdit()" class="btn btn-success btn-sm">‚úÖ</button>
                        <button onclick="cancelEdit()" class="btn btn-danger btn-sm">‚ùå</button>
                     </div>
                </div>
            </div>
            
            <div id="recipe-context">
                <!-- Details injected here -->
            </div>
            
            <div class="d-flex flex-column gap-2 mt-4">
                <button onclick="handleYes()" class="btn btn-success btn-lg w-100 py-3 action-btn">Add to List ‚úÖ</button>
                <div class="d-flex gap-2">
                    <button onclick="handleSkip()" class="btn btn-warning w-100 py-2 action-btn">Skip ‚è≠Ô∏è</button>
                </div>
                <div class="d-flex gap-2">
                    <button onclick="handleHaveIt()" class="btn btn-outline-secondary w-50 py-2 action-btn">Have it üè†</button>
                    <button onclick="handleBadInfo()" class="btn btn-outline-danger w-50 py-2 action-btn">Bad Info üö´</button>
                </div>
            </div>
            <div class="mt-3 text-muted">
                <small id="progress-indicator">Item 1 of 10</small>
            </div>
        </div>

        <!-- Skipped Meals View -->
        <div id="skipped-view" class="card mx-auto hidden">
            <h3 class="mb-3">Skipped Meals</h3>
            <p class="text-muted">The following meals required no ingredients according to the AI:</p>
            <ul id="skipped-list" class="list-group text-start mb-4" style="max-height: 200px; overflow-y: auto;">
                <!-- List items injected here -->
            </ul>
            <button onclick="checkPantry()" class="btn btn-primary btn-lg w-100">Continue</button>
        </div>

        <!-- Common Pantry View -->
        <div id="pantry-view" class="card mx-auto hidden">
            <h3 class="mb-3">Common Pantry</h3>
            <p class="text-muted">You likely have these. Select any you actually need:</p>
            
            <div id="pantry-list" class="d-flex flex-wrap gap-2 justify-content-center mb-4" style="max-height: 300px; overflow-y: auto; padding: 10px;">
                <!-- Pantry chips injected here -->
            </div>

            <button onclick="showManualAdd()" class="btn btn-primary btn-lg w-100">Continue</button>
        </div>

        <style>
            .pantry-chip {
                padding: 8px 16px;
                border-radius: 20px;
                border: 1px solid #dee2e6;
                background: white;
                cursor: pointer;
                transition: all 0.2s;
                user-select: none;
            }
            .pantry-chip.selected {
                background: #198754;
                color: white;
                border-color: #198754;
            }
            .pantry-chip:hover:not(.selected) {
                background: #f8f9fa;
                border-color: #adb5bd;
            }
        </style>

        <!-- Manual Add View -->
        <div id="manual-add-view" class="card mx-auto hidden">
            <h3 class="mb-3">Add Anything Else?</h3>

            <div class="input-group mb-3">
                <input type="text" id="manual-input" class="form-control" placeholder="Milk, Bread, etc." onkeydown="if(event.key==='Enter') addManualItem()">
                <button class="btn btn-outline-secondary" type="button" onclick="addManualItem()">Add</button>
            </div>

            <ul id="manual-list" class="list-group text-start mb-4 w-100" style="max-height: 200px; overflow-y: auto;">
                <!-- Manually added items -->
            </ul>

            <button onclick="finishPlanning()" class="btn btn-success btn-lg w-100">Finish & Sync</button>
        </div>

        <!-- Success View -->
        <div id="success-view" class="card mx-auto hidden">
            <h2 class="text-success">Done! üéâ</h2>
            <p>I've added <span id="count-added">0</span> items to your list.</p>
            <button onclick="location.reload()" class="btn btn-primary">Start Over</button>
        </div>

    </div>

    <script>
        let ingredientsQueue = [];
        let likelyHaveQueue = [];
        let skippedMeals = [];
        let selectedItems = [];
        let manualItems = [];
        let corrections = [];
        let rejectedItems = [];
        let currentIndex = 0;
        let sessionId = null;
        let isTestMode = false;
        let isEditing = false;

        const UNITS = [
            "cup", "cups", "tbsp", "tsp", "tablespoon", "teaspoon",
            "oz", "ounce", "ounces", "lb", "lbs", "pound", "pounds",
            "g", "gram", "grams", "kg", "ml", "l", "liter", "pinch",
            "slice", "slices", "clove", "cloves", "can", "cans", "jar", "jars",
            "package", "packages", "bunch", "bunches", "large", "small", "medium",
            "head", "heads", "bag", "bags"
        ];

        function normalizeIngredient(text) {
            let originalText = text;
            text = text.toLowerCase();
            text = text.replace(/\(.*?\)/g, '').trim(); // Remove parens

            // Extract quantity
            let quantity = "";
            const quantityMatch = text.match(/^([\d\s\/\.\-]+)/);
            if (quantityMatch) {
                quantity = quantityMatch[1].trim();
                text = text.replace(/^[\d\s\/\.\-]+/, '').trim();
            }

            let words = text.split(/\s+/);
            let unit = "";

            if (words.length > 0 && UNITS.includes(words[0])) {
                unit = words.shift();
            }

            if (words.length > 0 && words[0] === "of") {
                words.shift();
            }

            let baseName = words.join(" ").trim();

            if (!baseName) {
                baseName = originalText;
            }

            return {
                name: baseName,
                quantity: quantity,
                unit: unit
            };
        }

        function lockUI() {
            isEditing = true;
            document.querySelectorAll('.action-btn').forEach(btn => btn.disabled = true);
        }

        function unlockUI() {
            isEditing = false;
            document.querySelectorAll('.action-btn').forEach(btn => btn.disabled = false);
        }

        // Config State
        let config = {
            inputList: "Week's Meal Ideas",
            outputList: "Groceries",
            parentTask: ""
        };

        function showTestMode() {
            document.getElementById('start-view').classList.add('hidden');
            document.getElementById('test-input-view').classList.remove('hidden');
        }

        async function startTestScan() {
            const text = document.getElementById('test-input-text').value;
            if (!text.trim()) {
                alert("Please enter some text.");
                return;
            }

            isTestMode = true;
            document.getElementById('test-input-view').classList.add('hidden');
            document.getElementById('loading-view').classList.remove('hidden');
            document.getElementById('loading-text').innerText = "Processing test input...";

            try {
                const response = await fetch('/api/test_scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });

                await handleScanResponse(response);
            } catch (err) {
                alert("Error scanning meals.");
                console.error(err);
                location.reload();
            }
        }

        async function handleScanResponse(response) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = "";

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                let lines = buffer.split("\n\n");
                buffer = lines.pop();

                for (let line of lines) {
                    if (line.startsWith("data: ")) {
                        let data = JSON.parse(line.substring(6));

                        if (data.status) {
                            document.getElementById('loading-text').innerText = data.status;
                        }

                        if (data.error) {
                            alert(data.error);
                            location.reload();
                            return;
                        }

                        if (data.ingredients) {
                            // Separate likely-have items
                            ingredientsQueue = data.ingredients.filter(i => !i.likely_have);
                            likelyHaveQueue = data.ingredients.filter(i => i.likely_have);

                            if (data.session_id) {
                                sessionId = data.session_id;
                            }
                            if (data.skipped_meals) {
                                skippedMeals = data.skipped_meals;
                            }

                            if (ingredientsQueue.length === 0 && likelyHaveQueue.length === 0 && skippedMeals.length === 0) {
                                alert("No ingredients found!");
                                location.reload();
                                return;
                            }
                            startChat();
                        }
                    }
                }
            }
        }

        // Edit Logic
        function enableEdit() {
            lockUI();
            const display = document.getElementById('ingredient-display');
            const input = document.getElementById('ingredient-edit-input');
            const editBtn = document.getElementById('edit-btn');
            const editActions = document.getElementById('edit-actions');

            input.value = display.innerText;

            display.classList.add('hidden');
            editBtn.classList.add('hidden');
            editActions.classList.remove('hidden');

            input.classList.remove('hidden');
            input.focus();
        }

        function saveEdit() {
            const input = document.getElementById('ingredient-edit-input');
            const newName = input.value.trim();
            const originalName = ingredientsQueue[currentIndex].name;

            if (newName && newName !== originalName) {
                // Record correction
                corrections.push({
                    original_name: originalName,
                    corrected_name: newName,
                    context: ingredientsQueue[currentIndex].instances.map(i => i.raw)
                });

                // Update data
                ingredientsQueue[currentIndex].name = newName;

                // Update base_name to match the new title for consistent grouping
                const normalized = normalizeIngredient(newName);
                ingredientsQueue[currentIndex].base_name = normalized.name;

                document.getElementById('ingredient-display').innerText = newName;
            }

            cancelEdit();
        }

        function cancelEdit() {
            unlockUI();
            const display = document.getElementById('ingredient-display');
            const input = document.getElementById('ingredient-edit-input');
            const editBtn = document.getElementById('edit-btn');
            const editActions = document.getElementById('edit-actions');

            display.classList.remove('hidden');
            input.classList.add('hidden');
            editBtn.classList.remove('hidden');
            editActions.classList.add('hidden');
        }

        function enableInstanceEdit(index) {
            lockUI();
            document.getElementById(`inst-display-${index}`).classList.add('hidden');
            document.getElementById(`inst-edit-btn-${index}`).classList.add('hidden');
            document.getElementById(`inst-input-${index}`).classList.remove('hidden');
            document.getElementById(`inst-actions-${index}`).classList.remove('hidden');
            document.getElementById(`inst-input-${index}`).focus();

            // Handle enter key
            document.getElementById(`inst-input-${index}`).addEventListener('keydown', function(e) {
                if(e.key === 'Enter') saveInstanceEdit(index);
                if(e.key === 'Escape') cancelInstanceEdit(index);
            });
        }

        function cancelInstanceEdit(index) {
            unlockUI();
            document.getElementById(`inst-display-${index}`).classList.remove('hidden');
            document.getElementById(`inst-edit-btn-${index}`).classList.remove('hidden');
            document.getElementById(`inst-input-${index}`).classList.add('hidden');
            document.getElementById(`inst-actions-${index}`).classList.add('hidden');
        }

        function saveInstanceEdit(index) {
            const input = document.getElementById(`inst-input-${index}`);
            const newText = input.value.trim();
            const group = ingredientsQueue[currentIndex];
            const oldInstance = group.instances[index];

            if (!newText || newText === oldInstance.raw) {
                cancelInstanceEdit(index);
                return;
            }

            const normalized = normalizeIngredient(newText);
            const currentBaseName = group.base_name || group.name;

            // If name changed, move it
            if (normalized.name !== currentBaseName) {
                // Remove from current
                group.instances.splice(index, 1);

                // Add to new group
                let targetGroup = ingredientsQueue.find(g => (g.base_name || g.name) === normalized.name);
                const newInstance = {
                    raw: newText,
                    quantity: normalized.quantity,
                    unit: normalized.unit,
                    source: oldInstance.source,
                    original_name: normalized.name
                };

                if (targetGroup) {
                    targetGroup.instances.push(newInstance);
                } else {
                    // Create new group
                    ingredientsQueue.push({
                        name: normalized.name,
                        base_name: normalized.name,
                        instances: [newInstance],
                        original_task_ids: []
                    });
                }

                // If current group is empty, remove it
                if (group.instances.length === 0) {
                    ingredientsQueue.splice(currentIndex, 1);
                    // Since we removed current item, the next item slides into currentIndex
                    // So we don't need to increment currentIndex, but showCurrentItem will show the new item at currentIndex
                }

            } else {
                // Just update current instance
                oldInstance.raw = newText;
                oldInstance.quantity = normalized.quantity;
                oldInstance.unit = normalized.unit;
            }

            unlockUI();
            showCurrentItem();
        }

        // Handle Enter key in input
        document.getElementById('ingredient-edit-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                saveEdit();
            } else if (e.key === 'Escape') {
                cancelEdit();
            }
        });

        async function startScan() {
            document.getElementById('start-view').classList.add('hidden');
            document.getElementById('loading-view').classList.remove('hidden');
            document.getElementById('loading-text').innerText = "Connecting...";

            try {
                const response = await fetch('/api/scan_meals', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ input_list_name: config.inputList })
                });

                await handleScanResponse(response);
            } catch (err) {
                alert("Error scanning meals.");
                console.error(err);
                location.reload();
            }
        }

        function startChat() {
            document.getElementById('loading-view').classList.add('hidden');
            currentIndex = 0;
            if (ingredientsQueue.length === 0) {
                showSkippedMeals();
            } else {
                document.getElementById('chat-view').classList.remove('hidden');
                showCurrentItem();
            }
        }

        function showCurrentItem() {
            if (currentIndex >= ingredientsQueue.length) {
                showSkippedMeals();
                return;
            }

            const group = ingredientsQueue[currentIndex];
            
            document.getElementById('ingredient-display').innerText = group.name;
            
            // Show details (amounts and source recipes)
            const instancesHtml = group.instances.map((inst, index) => {
                const displayText = `${inst.raw} (from ${inst.source})`;
                return `
                    <div class="d-flex align-items-center mb-1">
                        <span id="inst-display-${index}" class="me-2">‚Ä¢ ${displayText}</span>
                        <input type="text" id="inst-input-${index}" class="form-control form-control-sm hidden" value="${inst.raw}" style="max-width: 300px;">

                        <button id="inst-edit-btn-${index}" onclick="enableInstanceEdit(${index})" class="btn btn-sm btn-link text-decoration-none p-0 ms-2" title="Edit">‚úèÔ∏è</button>

                        <div id="inst-actions-${index}" class="hidden ms-2">
                            <button onclick="saveInstanceEdit(${index})" class="btn btn-sm btn-success p-0 px-1">‚úÖ</button>
                            <button onclick="cancelInstanceEdit(${index})" class="btn btn-sm btn-danger p-0 px-1">‚ùå</button>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('recipe-context').innerHTML = instancesHtml;

            document.getElementById('progress-indicator').innerText = `Item ${currentIndex + 1} of ${ingredientsQueue.length}`;
        }

        function handleYes() {
            // Store the full object for better auditing
            selectedItems.push(JSON.parse(JSON.stringify(ingredientsQueue[currentIndex])));
            currentIndex++;
            showCurrentItem();
        }

        function handleHaveIt() {
            rejectedItems.push({
                name: ingredientsQueue[currentIndex].name,
                reason: "have_it",
                context: ingredientsQueue[currentIndex].instances.map(i => i.raw)
            });
            currentIndex++;
            showCurrentItem();
        }

        function handleSkip() {
            rejectedItems.push({
                name: ingredientsQueue[currentIndex].name,
                reason: "user_skipped",
                context: ingredientsQueue[currentIndex].instances.map(i => i.raw)
            });
            currentIndex++;
            showCurrentItem();
        }

        function handleBadInfo() {
            rejectedItems.push({
                name: ingredientsQueue[currentIndex].name,
                reason: "bad_parsing",
                context: ingredientsQueue[currentIndex].instances.map(i => i.raw)
            });
            currentIndex++;
            showCurrentItem();
        }

        function showSkippedMeals() {
            document.getElementById('chat-view').classList.add('hidden');

            if (!skippedMeals || skippedMeals.length === 0) {
                checkPantry();
                return;
            }

            const list = document.getElementById('skipped-list');
            list.innerHTML = skippedMeals.map(meal => `<li class="list-group-item">${meal}</li>`).join('');

            document.getElementById('skipped-view').classList.remove('hidden');
        }

        function checkPantry() {
            document.getElementById('skipped-view').classList.add('hidden');
            document.getElementById('chat-view').classList.add('hidden');

            if (likelyHaveQueue.length === 0) {
                showManualAdd();
                return;
            }

            renderPantry();
            document.getElementById('pantry-view').classList.remove('hidden');
        }

        function renderPantry() {
            const list = document.getElementById('pantry-list');
            list.innerHTML = likelyHaveQueue.map((item, index) => {
                const isSelected = selectedItems.some(si => si.name === item.name);
                return `
                    <div class="pantry-chip ${isSelected ? 'selected' : ''}" onclick="togglePantryItem(${index})">
                        ${item.name}
                    </div>
                `;
            }).join('');
        }

        function togglePantryItem(index) {
            const item = likelyHaveQueue[index];
            const selectedIdx = selectedItems.findIndex(si => si.name === item.name);

            if (selectedIdx > -1) {
                selectedItems.splice(selectedIdx, 1);
            } else {
                selectedItems.push(JSON.parse(JSON.stringify(item)));
            }
            renderPantry();
        }

        function showManualAdd() {
            document.getElementById('pantry-view').classList.add('hidden');
            document.getElementById('skipped-view').classList.add('hidden');
            document.getElementById('chat-view').classList.add('hidden');
            document.getElementById('manual-add-view').classList.remove('hidden');
            renderManualList();
        }

        function addManualItem() {
            const input = document.getElementById('manual-input');
            const val = input.value.trim();
            if (val) {
                manualItems.push(val);
                input.value = "";
                renderManualList();
            }
            input.focus();
        }

        function removeManualItem(index) {
            manualItems.splice(index, 1);
            renderManualList();
        }

        function renderManualList() {
            const list = document.getElementById('manual-list');
            if (manualItems.length === 0) {
                list.innerHTML = '<li class="list-group-item text-muted fst-italic text-center">No extra items added</li>';
            } else {
                list.innerHTML = manualItems.map((item, index) => `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        ${item}
                        <button onclick="removeManualItem(${index})" class="btn btn-sm btn-danger">X</button>
                    </li>
                `).join('');
            }
        }

        async function finishPlanning() {
            document.getElementById('manual-add-view').classList.add('hidden');
            document.getElementById('loading-view').classList.remove('hidden');
            document.getElementById('loading-text').innerText = "Syncing to TickTick...";

            const payload = {
                items: selectedItems.map(i => i.name),
                selected_objects: selectedItems,
                manual_items: manualItems,
                corrections: corrections,
                rejected_items: rejectedItems,
                output_list_name: config.outputList,
                parent_task_name: config.parentTask,
                session_id: sessionId,
                test_mode: isTestMode
            };

            try {
                const response = await fetch('/api/create_grocery_list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                document.getElementById('loading-view').classList.add('hidden');
                document.getElementById('success-view').classList.remove('hidden');
                document.getElementById('count-added').innerText = payload.items.length + manualItems.length;
            } catch (err) {
                alert("Error creating list.");
            }
        }
    </script>
</body>
</html>