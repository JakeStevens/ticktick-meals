<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meal Bot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; display: flex; align-items: center; justify-content: center; height: 100vh; }
        .card { width: 100%; max-width: 600px; min-height: 400px; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: center; }
        .btn-action { padding: 15px 0; font-size: 1.5rem; width: 45%; border-radius: 12px; }
        .hidden { display: none !important; }
        #ingredient-display { font-size: 2.0rem; font-weight: bold; text-transform: capitalize; }
        #recipe-context { font-size: 0.9rem; color: #6c757d; text-align: left; margin-top: 10px; max-height: 150px; overflow-y: auto; background: #f1f3f5; padding: 10px; border-radius: 8px;}
        .config-row { text-align: left; margin-bottom: 15px; }
    </style>
</head>
<body>

    <div class="container text-center">
        
        <!-- Config/Start View -->
        <div id="start-view" class="card mx-auto">
            <h2>Setup Planner</h2>
            
            <div class="config-row mt-4">
                <label class="form-label fw-bold">Scan List (Recipes)</label>
                <input type="text" id="input-list" class="form-control" value="Week's Meal Ideas" readonly disabled>
                <div class="form-text">Scanning list: Week's Meal Ideas, Section: Weekly Plan</div>
            </div>

            <div class="config-row">
                <label class="form-label fw-bold">Target List (Groceries)</label>
                <input type="text" id="output-list" class="form-control" value="Groceries" readonly disabled>
            </div>

            {% if logged_in %}
            <button onclick="startScan()" class="btn btn-primary btn-lg mt-3">Start Scanning</button>
            {% else %}
            <a href="/login" class="btn btn-primary btn-lg mt-3">Login to TickTick</a>
            {% endif %}
            <button onclick="showTestMode()" class="btn btn-secondary mt-3">Test Mode</button>
        </div>

        <!-- Test Input View -->
        <div id="test-input-view" class="card mx-auto hidden">
            <h2>Test Mode</h2>
            <p>Enter recipes or URLs (one per line):</p>
            <textarea id="test-input-text" class="form-control mb-3" rows="10" placeholder="https://example.com/recipe&#10;Chicken Parmesan"></textarea>
            <button onclick="startTestScan()" class="btn btn-primary btn-lg">Run Test</button>
            <button onclick="location.reload()" class="btn btn-outline-secondary mt-2">Cancel</button>
        </div>

        <!-- Loading View -->
        <div id="loading-view" class="card mx-auto hidden">
            <div class="spinner-border text-primary mx-auto" role="status" style="width: 3rem; height: 3rem;"></div>
            <h4 class="mt-3" id="loading-text">Reading recipes...</h4>
        </div>

        <!-- Chat Interface -->
        <div id="chat-view" class="card mx-auto hidden">
            <div class="text-muted text-uppercase small fw-bold">Do you need...</div>
            
            <div class="d-flex justify-content-center align-items-center my-3">
                <span id="ingredient-display">Onions</span>
                <input type="text" id="ingredient-edit-input" class="form-control hidden text-center fw-bold" style="font-size: 1.5rem; max-width: 300px;">

                <div class="ms-2">
                     <button id="edit-btn" onclick="enableEdit()" class="btn btn-outline-secondary btn-sm" title="Edit">‚úèÔ∏è</button>
                     <div id="edit-actions" class="hidden d-flex gap-1">
                        <button onclick="saveEdit()" class="btn btn-success btn-sm">‚úÖ</button>
                        <button onclick="cancelEdit()" class="btn btn-danger btn-sm">‚ùå</button>
                     </div>
                </div>
            </div>
            
            <div id="recipe-context">
                <!-- Details injected here -->
            </div>
            
            <div class="d-flex flex-column gap-2 mt-4">
                <button onclick="handleYes()" class="btn btn-success btn-lg w-100 py-3">Add to List ‚úÖ</button>
                <div class="d-flex gap-2">
                    <button onclick="handleHaveIt()" class="btn btn-outline-secondary w-50 py-2">Have it üè†</button>
                    <button onclick="handleBadInfo()" class="btn btn-outline-danger w-50 py-2">Bad Info üö´</button>
                </div>
            </div>
            <div class="mt-3 text-muted">
                <small id="progress-indicator">Item 1 of 10</small>
            </div>
        </div>

        <!-- Skipped Meals View -->
        <div id="skipped-view" class="card mx-auto hidden">
            <h3 class="mb-3">Skipped Meals</h3>
            <p class="text-muted">The following meals required no ingredients according to the AI:</p>
            <ul id="skipped-list" class="list-group text-start mb-4" style="max-height: 200px; overflow-y: auto;">
                <!-- List items injected here -->
            </ul>
            <button onclick="showManualAdd()" class="btn btn-primary btn-lg w-100">Continue</button>
        </div>

        <!-- Manual Add View -->
        <div id="manual-add-view" class="card mx-auto hidden">
            <h3 class="mb-3">Add Anything Else?</h3>

            <div class="input-group mb-3">
                <input type="text" id="manual-input" class="form-control" placeholder="Milk, Bread, etc." onkeydown="if(event.key==='Enter') addManualItem()">
                <button class="btn btn-outline-secondary" type="button" onclick="addManualItem()">Add</button>
            </div>

            <ul id="manual-list" class="list-group text-start mb-4 w-100" style="max-height: 200px; overflow-y: auto;">
                <!-- Manually added items -->
            </ul>

            <button onclick="finishPlanning()" class="btn btn-success btn-lg w-100">Finish & Sync</button>
        </div>

        <!-- Success View -->
        <div id="success-view" class="card mx-auto hidden">
            <h2 class="text-success">Done! üéâ</h2>
            <p>I've added <span id="count-added">0</span> items to your list.</p>
            <button onclick="location.reload()" class="btn btn-primary">Start Over</button>
        </div>

    </div>

    <script>
        let ingredientsQueue = [];
        let skippedMeals = [];
        let selectedItems = [];
        let manualItems = [];
        let corrections = [];
        let rejectedItems = [];
        let currentIndex = 0;
        let sessionId = null;
        let isTestMode = false;

        // Config State
        let config = {
            inputList: "Week's Meal Ideas",
            outputList: "Groceries",
            parentTask: ""
        };

        function showTestMode() {
            document.getElementById('start-view').classList.add('hidden');
            document.getElementById('test-input-view').classList.remove('hidden');
        }

        async function startTestScan() {
            const text = document.getElementById('test-input-text').value;
            if (!text.trim()) {
                alert("Please enter some text.");
                return;
            }

            isTestMode = true;
            document.getElementById('test-input-view').classList.add('hidden');
            document.getElementById('loading-view').classList.remove('hidden');
            document.getElementById('loading-text').innerText = "Processing test input...";

            try {
                const response = await fetch('/api/test_scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });

                await handleScanResponse(response);
            } catch (err) {
                alert("Error scanning meals.");
                console.error(err);
                location.reload();
            }
        }

        async function handleScanResponse(response) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = "";

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                let lines = buffer.split("\n\n");
                buffer = lines.pop();

                for (let line of lines) {
                    if (line.startsWith("data: ")) {
                        let data = JSON.parse(line.substring(6));

                        if (data.status) {
                            document.getElementById('loading-text').innerText = data.status;
                        }

                        if (data.error) {
                            alert(data.error);
                            location.reload();
                            return;
                        }

                        if (data.ingredients) {
                            ingredientsQueue = data.ingredients;
                            if (data.session_id) {
                                sessionId = data.session_id;
                            }
                            if (data.skipped_meals) {
                                skippedMeals = data.skipped_meals;
                            }

                            if (ingredientsQueue.length === 0 && skippedMeals.length === 0) {
                                alert("No ingredients found!");
                                location.reload();
                                return;
                            }
                            startChat();
                        }
                    }
                }
            }
        }

        // Edit Logic
        function enableEdit() {
            const display = document.getElementById('ingredient-display');
            const input = document.getElementById('ingredient-edit-input');
            const editBtn = document.getElementById('edit-btn');
            const editActions = document.getElementById('edit-actions');

            input.value = display.innerText;

            display.classList.add('hidden');
            editBtn.classList.add('hidden');
            editActions.classList.remove('hidden');

            input.classList.remove('hidden');
            input.focus();
        }

        function saveEdit() {
            const input = document.getElementById('ingredient-edit-input');
            const newName = input.value.trim();
            const originalName = ingredientsQueue[currentIndex].name;

            if (newName && newName !== originalName) {
                // Record correction
                corrections.push({
                    original_name: originalName,
                    corrected_name: newName,
                    context: ingredientsQueue[currentIndex].raw_lines
                });

                // Update data
                ingredientsQueue[currentIndex].name = newName;
                document.getElementById('ingredient-display').innerText = newName;
            }

            cancelEdit();
        }

        function cancelEdit() {
            const display = document.getElementById('ingredient-display');
            const input = document.getElementById('ingredient-edit-input');
            const editBtn = document.getElementById('edit-btn');
            const editActions = document.getElementById('edit-actions');

            display.classList.remove('hidden');
            input.classList.add('hidden');
            editBtn.classList.remove('hidden');
            editActions.classList.add('hidden');
        }

        // Handle Enter key in input
        document.getElementById('ingredient-edit-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                saveEdit();
            } else if (e.key === 'Escape') {
                cancelEdit();
            }
        });

        async function startScan() {
            document.getElementById('start-view').classList.add('hidden');
            document.getElementById('loading-view').classList.remove('hidden');
            document.getElementById('loading-text').innerText = "Connecting...";

            try {
                const response = await fetch('/api/scan_meals', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ input_list_name: config.inputList })
                });

                await handleScanResponse(response);
            } catch (err) {
                alert("Error scanning meals.");
                console.error(err);
                location.reload();
            }
        }

        function startChat() {
            document.getElementById('loading-view').classList.add('hidden');
            currentIndex = 0;
            if (ingredientsQueue.length === 0) {
                showSkippedMeals();
            } else {
                document.getElementById('chat-view').classList.remove('hidden');
                showCurrentItem();
            }
        }

        function showCurrentItem() {
            if (currentIndex >= ingredientsQueue.length) {
                showSkippedMeals();
                return;
            }

            const group = ingredientsQueue[currentIndex];
            
            document.getElementById('ingredient-display').innerText = group.name;
            
            // Show details (amounts and source recipes)
            const detailsHtml = group.details.map(d => `<div>‚Ä¢ ${d}</div>`).join('');
            document.getElementById('recipe-context').innerHTML = detailsHtml;

            document.getElementById('progress-indicator').innerText = `Item ${currentIndex + 1} of ${ingredientsQueue.length}`;
        }

        function handleYes() {
            // Add the name of the ingredient group
            selectedItems.push(ingredientsQueue[currentIndex].name);
            currentIndex++;
            showCurrentItem();
        }

        function handleHaveIt() {
            rejectedItems.push({
                name: ingredientsQueue[currentIndex].name,
                reason: "have_it",
                context: ingredientsQueue[currentIndex].raw_lines
            });
            currentIndex++;
            showCurrentItem();
        }

        function handleBadInfo() {
            rejectedItems.push({
                name: ingredientsQueue[currentIndex].name,
                reason: "bad_parsing",
                context: ingredientsQueue[currentIndex].raw_lines
            });
            currentIndex++;
            showCurrentItem();
        }

        function showSkippedMeals() {
            document.getElementById('chat-view').classList.add('hidden');

            if (!skippedMeals || skippedMeals.length === 0) {
                showManualAdd();
                return;
            }

            const list = document.getElementById('skipped-list');
            list.innerHTML = skippedMeals.map(meal => `<li class="list-group-item">${meal}</li>`).join('');

            document.getElementById('skipped-view').classList.remove('hidden');
        }

        function showManualAdd() {
            document.getElementById('skipped-view').classList.add('hidden');
            document.getElementById('chat-view').classList.add('hidden');
            document.getElementById('manual-add-view').classList.remove('hidden');
            renderManualList();
        }

        function addManualItem() {
            const input = document.getElementById('manual-input');
            const val = input.value.trim();
            if (val) {
                manualItems.push(val);
                input.value = "";
                renderManualList();
            }
            input.focus();
        }

        function removeManualItem(index) {
            manualItems.splice(index, 1);
            renderManualList();
        }

        function renderManualList() {
            const list = document.getElementById('manual-list');
            if (manualItems.length === 0) {
                list.innerHTML = '<li class="list-group-item text-muted fst-italic text-center">No extra items added</li>';
            } else {
                list.innerHTML = manualItems.map((item, index) => `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        ${item}
                        <button onclick="removeManualItem(${index})" class="btn btn-sm btn-danger">X</button>
                    </li>
                `).join('');
            }
        }

        async function finishPlanning() {
            document.getElementById('manual-add-view').classList.add('hidden');
            document.getElementById('loading-view').classList.remove('hidden');
            document.getElementById('loading-text').innerText = "Syncing to TickTick...";

            const finalItems = [...selectedItems, ...manualItems];

            try {
                const response = await fetch('/api/create_grocery_list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        items: finalItems,
                        manual_items: manualItems,
                        corrections: corrections,
                        rejected_items: rejectedItems,
                        output_list_name: config.outputList,
                        parent_task_name: config.parentTask,
                        session_id: sessionId,
                        test_mode: isTestMode
                    })
                });
                
                document.getElementById('loading-view').classList.add('hidden');
                document.getElementById('success-view').classList.remove('hidden');
                document.getElementById('count-added').innerText = finalItems.length;
            } catch (err) {
                alert("Error creating list.");
            }
        }
    </script>
</body>
</html>